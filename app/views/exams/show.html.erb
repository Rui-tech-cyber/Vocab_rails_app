<h1><%= @exam.word_book.title %> のテスト</h1>

<ul class="nav nav-tabs" id="examTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="ja-en-tab" data-bs-toggle="tab" data-bs-target="#ja-en" type="button" role="tab">
      英 → 日
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="en-ja-tab" data-bs-toggle="tab" data-bs-target="#en-ja" type="button" role="tab">
      日 → 英
    </button>
  </li>
</ul>

<div class="tab-content mt-3" id="examTabContent">
  <div class="tab-pane fade show active" id="ja-en" role="tabpanel">
    <%= form_with url: exam_exam_answers_path(@exam), method: :post, id: "exam-form-ja-en" do %>
      <% @questions.each do |q| %>
        <div class="mb-4 p-3 border rounded">
          <p><strong>問題:</strong> <%= q.word.term %></p>
          <%= label_tag "answers[#{q.id}]", "単語の意味を入力してください" %>
          <%= text_field_tag "answers[#{q.id}]", nil, class: "form-control answer-input", data: { question_id: q.id } %>
        </div>
      <% end %>

      <%= hidden_field_tag :mode, "en_to_jp" %>

      <%= button_tag "回答する", type: "button", class: "btn btn-primary mt-3 submit-btn", data: { form_id: "exam-form-ja-en" } %>
    <% end %>
  </div>

  <div class="tab-pane fade" id="en-ja" role="tabpanel">
    <%= form_with url: exam_exam_answers_path(@exam), method: :post, id: "exam-form-en-ja" do %>
      <% @questions.each do |q| %>
        <div class="mb-4 p-3 border rounded">
          <p><strong>問題:</strong> <%= q.word.meaning %></p>
          <%= label_tag "answers[#{q.id}]", "英単語を入力してください" %>
          <%= text_field_tag "answers[#{q.id}]", nil, class: "form-control answer-input", data: { question_id: q.id } %>
        </div>
      <% end %>

      <%= hidden_field_tag :mode, "jp_to_en" %>

      <%= button_tag "回答する", type: "button", class: "btn btn-primary mt-3 submit-btn", data: { form_id: "exam-form-en-ja" } %>
    <% end %>
  </div>
</div>

<hr>
<%= link_to "トップページに戻る", root_path, class: "btn btn-secondary mb-3" %>

<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">回答を送信する</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        本当に回答を送信しますか？
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-primary" id="confirm-submit">送信する</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("turbo:load", () => {
  const submitBtns = document.querySelectorAll(".submit-btn")
  const confirmSubmitBtn = document.getElementById("confirm-submit")
  let currentForm = null

  if (!submitBtns || !confirmSubmitBtn) return

  submitBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      const formId = btn.dataset.formId
      const form = document.getElementById(formId)
      if (!form) return

      const inputs = form.querySelectorAll(".answer-input")
      inputs.forEach(input => {
        if (input.value.trim() === "") {
          input.classList.add("is-invalid")
          input.value = ""
        } else {
          input.classList.remove("is-invalid")
        }
      })

      currentForm = form
      const modalEl = document.getElementById('confirmModal')
      const modal = new bootstrap.Modal(modalEl)
      modal.show()
    })
  })

  confirmSubmitBtn.addEventListener("click", () => {
    if (currentForm) currentForm.submit()
  })
})
</script>
