<div class="container text-center mt-5">
  <h1 class="mb-4 fw-bold">🔍 単語検索</h1>

  <%= form_with url: search_words_path, method: :get, local: true, class: "mb-4" do %>
    <%= hidden_field_tag :default_word_book_id, params[:default_word_book_id] %>
    <div class="input-group mb-3 w-75 mx-auto">
      <%= text_field_tag :term, params[:term], class: "form-control", placeholder: "検索ワードを入力" %>
      <button class="btn btn-primary hover-scale" type="submit">検索</button>
    </div>
  <% end %>

  <% if flash.now[:alert].present? %>
    <div class="alert alert-warning w-75 mx-auto"><%= flash.now[:alert] %></div>
  <% end %>

  <% if @results.present? %>
    <h2 class="mb-3">検索結果</h2>
    <ul class="list-group w-75 mx-auto text-start">
      <% @results.each do |entry| %>
        <li class="list-group-item d-flex flex-column align-items-start">
          <p class="mb-1"><strong><%= entry[:word] %></strong>: <%= entry[:meaning] %></p>
          <% if entry[:example].present? %>
            <small class="text-muted">例文: <%= entry[:example] %></small>
          <% end %>

          <% if user_signed_in? %>
            <button type="button" 
              class="btn btn-sm btn-success mt-2 align-self-end hover-scale open-modal-btn" 
              data-term="<%= entry[:word] %>" 
              data-meaning="<%= entry[:meaning] %>">
              💾 単語帳に保存する
            </button>
          <% else %>
            <p class="text-muted mt-2">保存するにはログインしてください。</p>
          <% end %>
        </li>
      <% end %>
    </ul>
  <% elsif params[:term].present? %>
    <p class="mt-3">検索結果が見つかりませんでした。</p>
  <% end %>

  <hr class="my-4">

  <%= link_to "トップページに戻る", root_path, class: "btn btn-lg btn-outline-secondary rounded-pill shadow-sm hover-scale" %>
</div>

<% if user_signed_in? %>
  <div class="modal fade" id="saveWordModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">単語を追加する単語帳を選択</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <%= form_with scope: :word, url: words_path, method: :post, local: true, id: "saveWordForm" do |f| %>
            <%= f.hidden_field :term,    id: "modal_word_term" %>
            <%= f.hidden_field :meaning, id: "modal_word_meaning" %>
            <%= f.hidden_field :word_book_id, id: "modal_word_book_id" %>
            <div class="mb-3">
              <%= label_tag "word[word_book_id]", "単語帳" %>
              <%= select_tag "word[word_book_id]", options_from_collection_for_select(current_user.word_books.where(dummy: [false, nil]), :id, :title), id: "word_book_select", class: "form-select" %>
            </div>
            <%= submit_tag "保存する", class: "btn btn-success hover-scale" %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener("turbo:load", () => {
    const modalEl = document.getElementById("saveWordModal")
    if (!modalEl) return

    const modal = new bootstrap.Modal(modalEl)
    const form = document.getElementById("saveWordForm")
    const termInput = document.getElementById("modal_word_term")
    const meaningInput = document.getElementById("modal_word_meaning")
    const wordBookInput = document.getElementById("modal_word_book_id")
    const select = document.getElementById("word_book_select")

    if (!form || !termInput || !meaningInput || !wordBookInput || !select) return

    let selectedData = { term: "", meaning: "" }

    document.querySelectorAll(".open-modal-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        selectedData.term = btn.dataset.term || ""
        selectedData.meaning = btn.dataset.meaning || ""
        modal.show()
      })
    })

    select.addEventListener("change", (e) => {
      wordBookInput.value = e.target.value
    })

    form.addEventListener("submit", () => {
      termInput.value = selectedData.term
      meaningInput.value = selectedData.meaning
      wordBookInput.value = select.value
    })
  })
  </script>
<% end %>

<style>
  .hover-scale {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .hover-scale:hover {
    transform: scale(1.05);
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
  }
</style>
